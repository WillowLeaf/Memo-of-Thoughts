\documentclass{article}

\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{framed}

\title{Derivation of RNN}
\author{Lifu Huang}
\date{Mar. 2016}
\begin{document}
	\maketitle
	\section{Loss Function}
	\begin{equation}
	\begin{aligned}
		J &= \frac{1}{T}\sum_{t=1}^{T} J^{(t)} \\
		&= \frac{1}{T}\sum_{t=1}^{T} \sum_{j=1}^{|V|} -y^{(t)}_j \log \hat{y}^{(t)}_j \\
		&= \frac{1}{T} \sum_{t=1}^T -\log{\hat{y}_k^{(t)}}	\\
	\end{aligned}
	\end{equation}
	
	\begin{equation}
	\begin{aligned}	
		J^{(t)} &= -\log{\hat{y}^{(t)}_k}
	\end{aligned}
	\end{equation}
	
	\section{Forward Propagation}
	\begin{equation}
	\begin{aligned}
		h^{(t)} 
		&= f(z^{(1)(t)}) \\
		&= f(H \cdot h^{(t-1)} + W \cdot x^{(t)} + b_1) \\
		\hat{y}^{(t)} &= g(z^{(2)(t)}) \\
		&= g(U \cdot h^{(t)} + c) \\
	\end{aligned}
	\end{equation}
	\newpage
	\section{Backward Propagation}
	For the purpose of simplicity, all derivation in this chapter will be made with respect to the loss function of a single time step. Moreover, we will presume that $g(x)$ here is the softmax function, which can be easily substituted with any other functions as needed. 
	\subsection{Derivation of $\delta$s}
	\begin{equation}
	\begin{aligned}
		\frac{\partial J^{(t)}}{\partial z^{(2)(t)}} &= \frac{\partial}{\partial z^{(2)(t)}} (-\log{\hat{y}^{(t)}_k}) \\
		&= \frac{\partial}{\partial z^{(2)(t)}} (-z^{(2)(t)}_k + \log{\sum_{j=1}^{|V|} z^{(2)(t)}_j}) \\
		&= (\hat{y}^{(t)} - y^{(t)})^T \\
	\end{aligned}
	\end{equation}
	
	\begin{equation}
	\begin{aligned}
		\delta^{(2)(t)} &= \nabla_{z^{(2)(t)}} J^{(t)} \\
		&= \hat{y}^{(t)} - y^{(t)} \\
	\end{aligned}
	\end{equation}
	
	\begin{equation}
		\begin{aligned}
		\frac{\partial J^{(t)}}{\partial z^{(1)(t)}} &= \frac{\partial J^{(t)}}{\partial z^{(2)(t)}} 
		\frac{\partial z^{(2)(t)}}{\partial z^{(1)(t)}} \\
		&= (\delta^{(2)(t)})^T \cdot \frac{\partial}{\partial z^{(1)(t)}} (U \cdot f(z^{(1)(t)}) + c)\\
		&= (\delta^{(2)(t)})^T \cdot U \cdot diag[f'(z^{(1)(t)})]\\
		\end{aligned}
	\end{equation}
	
	\begin{equation}
	\begin{aligned}
		\delta^{(1)(t)} &= \nabla_{z^{(1)(t)}} J^{(t)} \\
		&= diag[f'(z^{(1)(t)})] \cdot U^T \cdot \delta^{(2)(t)}\\
	\end{aligned}
	\end{equation}
	
	\begin{equation}
		\begin{aligned}
		\frac{\partial J^{(t)}}{\partial z^{(1)(t-c)}} &= \frac{\partial J^{(t)}}{\partial z^{(1)(t-c+1)}} 
		\frac{\partial z^{(1)(t-c+1)}}{\partial z^{(1)(t-c)}} \\
		&= (\delta^{(1)(t-c+1)})^T \cdot \frac{\partial}{\partial z^{(1)(t-c)}} (H \cdot f(z^{(1)(t-c)}) + W \cdot x^{(t-c)} + b_1)\\
		&= (\delta^{(1)(t-c+1)})^T \cdot H \cdot diag[f'(z^{(1)(t-c)})]\\
		\end{aligned}
	\end{equation}
	
	\begin{equation}
		\begin{aligned}
		\delta^{(1)(t-c)} &= \nabla_{z^{(1)(t-c)}} J^{(t)} \\
		&= diag[f'(z^{(1)(t-c)})] \cdot H^T \cdot \delta^{(1)(t-c+1)}\\
		\end{aligned}
	\end{equation}
	
	\subsection{Gradients of Parameters}
	\begin{equation}
	\begin{aligned}
		\frac{\partial J^{(t)}}{\partial U} &= \frac{\partial J^{(t)}}{\partial z^{(2)(t)}} 
		\frac{\partial z^{(2)(t)}}{\partial U} \\
		&= (\delta^{(2)(t)})^T \cdot \left[\frac{\partial z^{(2)(t)}_i}{\partial U}\right]\\
		&= (\delta^{(2)(t)})^T \cdot \left[\frac{\partial }{\partial U} ((\epsilon_i)^T \cdot U \cdot a^{(1)(t)} + b_{2,i})\right]\\
		&= (\delta^{(2)(t)})^T \cdot \left[a^{(1)(t)} \cdot (\epsilon_i)^T\right]\\	
		&= a^{(1)(t)} \cdot (\delta^{(1)(t)})^T\\
	\end{aligned}
	\end{equation}
	
	\begin{equation}
	\begin{aligned}
		\nabla_U J^{(t)} &= \delta^{(2)(t)} \cdot (a^{(1)(t)})^T\\
	\end{aligned}
	\end{equation}
	
	\begin{equation}
	\begin{aligned}
		\frac{\partial J^{(t)}}{\partial c} &= \frac{\partial J^{(t)}}{\partial z^{(2)(t)}} 
		\frac{\partial z^{(2)(t)}}{\partial c} \\
		&= (\delta^{(2)(t)})^T \cdot I \\
		&= (\delta^{(2)(t)})^T \\
	\end{aligned}
	\end{equation}
	
	\begin{equation}
	\begin{aligned}
		\nabla_{c} J^{(t)} &= \delta^{(2)(t)} \\
	\end{aligned}
	\end{equation}
	
	\begin{equation}
	\begin{aligned}
		\frac{\partial J^{(t)}}{\partial H} &= \sum_{i=1}^{t} \frac{\partial J^{(t)}}{\partial H}\bigg|_{(i)}  \\
		&= \sum_{i=1}^{t}
		\frac{\partial J^{(t)}}{\partial z^{(1)(i)}} 
		\frac{\partial z^{(1)(i)}}{\partial H}\bigg|_{(i)} \\
		&= \sum_{i=1}^{t}
		(\delta^{(1)(i)})^T \cdot \left[\frac{\partial }{\partial H} ((\epsilon_i)^T \cdot H \cdot h^{(i-1)} + (\epsilon_i)^T \cdot W \cdot x^{(i)} + b_{1,i})\right] \\
		&= \sum_{i=1}^{t}
		(\delta^{(1)(i)})^T \cdot \left[h^{(i-1)} \cdot (\epsilon_i)^T\right]\\	
		&= \sum_{i=1}^{t} h^{(i-1)} \cdot (\delta^{(1)(i)})^T\\
	\end{aligned}
	\end{equation}
	
	\begin{equation}
	\begin{aligned}
		\nabla_H J^{(t)} &= \sum_{i=1}^{t} \delta^{(1)(i)} \cdot  (h^{(i-1)})^T\\
	\end{aligned}
	\end{equation}
	
	\begin{equation}
	\begin{aligned}
		\frac{\partial J^{(t)}}{\partial W} &= \sum_{i=1}^{t} \frac{\partial J^{(t)}}{\partial W}\bigg|_{(i)}  \\
		&= \sum_{i=1}^{t}
		\frac{\partial J^{(t)}}{\partial z^{(1)(i)}} 
		\frac{\partial z^{(1)(i)}}{\partial W}\bigg|_{(i)} \\
		&= \sum_{i=1}^{t}
		(\delta^{(1)(i)})^T \cdot \left[\frac{\partial }{\partial W}((\epsilon_i)^T \cdot H \cdot h^{(i-1)} + (\epsilon_i)^T \cdot W \cdot x^{(i)} + b_{1,i})\right] \\
		&= \sum_{i=1}^{t}
		(\delta^{(1)(i)})^T \cdot \left[x^{(i)} \cdot (\epsilon_i)^T\right]\\	
		&= \sum_{i=1}^{t} x^{(i)} \cdot (\delta^{(1)(i)})^T\\
	\end{aligned}
	\end{equation}
	
	\begin{equation}
	\begin{aligned}
		\nabla_W J^{(t)} &= \sum_{i=1}^{t} \delta^{(1)(i)} \cdot  (x^{(i)})^T\\
	\end{aligned}
	\end{equation}	
		
	\begin{equation}
	\begin{aligned}
		\frac{\partial J^{(t)}}{\partial b1} &= \sum_{i=1}^{t} \frac{\partial J^{(t)}}{\partial b1}\bigg|_{(i)}  \\
		&= \sum_{i=1}^{t}
		\frac{\partial J^{(t)}}{\partial z^{(1)(i)}} 
		\frac{\partial z^{(1)(i)}}{\partial b1}\bigg|_{(i)} \\
		&= \sum_{i=1}^{t}
		(\delta^{(1)(i)})^T \cdot I \\
		&= \sum_{i=1}^{t} (\delta^{(1)(i)})^T\\
	\end{aligned}
	\end{equation}
	
	\begin{equation}
	\begin{aligned}
		\nabla_{b_1} J^{(t)} &= \sum_{i=1}^{t} \delta^{(1)(i)} \\
	\end{aligned}
	\end{equation}	
	
	\subsection{Conclusion}
	\begin{align}
		\delta^{(2)(t)} &= \hat{y}^{(t)} - y^{(t)} \\
		\delta^{(1)(t)} &= diag[f'(z^{(1)(t)})] \cdot U^T \cdot \delta^{(2)(t)}\\
		\delta^{(1)(t-c)} &= diag[f'(z^{(1)(t-c)})] \cdot H^T \cdot \delta^{(1)(t-c+1)}\\
		\nabla_U J^{(t)} &= \delta^{(2)(t)} \cdot (a^{(1)(t)})^T\\
		\nabla_{c} J^{(t)} &= \delta^{(2)(t)} \\
		\nabla_H J^{(t)} &= \sum_{i=1}^{t} \delta^{(1)(i)} \cdot  (h^{(i-1)})^T\\
		\nabla_W J^{(t)} &= \sum_{i=1}^{t} \delta^{(1)(i)} \cdot  (x^{(i)})^T\\
		\nabla_{b_1} J^{(t)} &= \sum_{i=1}^{t} \delta^{(1)(i)} \\
	\end{align}
	
	\newpage
	\section{Trick for Implementation}
	Derivation above is made with respect to the loss function of a single time step, (i.e. $\nabla J^{(t)}$). When taking derivative of the final loss function $\nabla J$ with respect to $H$, $W$, and $b1$, instead of calculate $\nabla J^{(t)}$ for every time step and sum them up at last, which is correct but inefficient, we backprop only once by keeping record of $\gamma^{(t)}$, which is the accumulating sum of $\delta^{(1)(i)(t)}$ over range $t$ to $T$.\footnote{We will slightly change our notation here by adding one more superscript to $\delta$ so as to differentiate $\delta$ from different $J^{(t)}$, now $\delta^{(1)(i)(t)} = \nabla_{z^{(1)(t)}}J^{(i)}$.} \\\\
	It is easy to find that,\\
	\begin{equation}
	\begin{aligned}
		\text{for $1 \le t \le T-1$:}\\
		\gamma^{(t)} &= \sum_{i=t}^{T} \delta^{(1)(i)(t)} \\
		&= \delta^{(1)(t)(t)} + \sum_{i=t+1}^{T} \delta^{(1)(i)(t)} \\
		&= \delta^{(1)(t)(t)} + \sum_{i=t+1}^{T} diag[f'(z^{(1)(t)})] \cdot H^T \cdot \delta^{(1)(i)(t+1)} \\
		&= \delta^{(1)(t)(t)} + diag[f'(z^{(1)(t)})] \cdot H^T \cdot \left(\sum_{i=t+1}^{T} \delta^{(1)(i)(t+1)}\right) \\		
		&= \delta^{(1)(t)(t)} + diag[f'(z^{(1)(t)})] \cdot H^T \cdot \gamma^{(t+1)} 
	\end{aligned}
	\end{equation}
	
	Thus,\\
	\begin{equation}
	\begin{aligned}
		\gamma^{(t)} &= 
		\begin{cases}
			\delta^{(1)(t)(t)} &t=T \\
			\delta^{(1)(t)(t)} + diag[f'(z^{(1)(t)})] \cdot H^T \cdot \gamma^{(t+1)} & otherwise
		\end{cases}
	\end{aligned}
	\end{equation}
	
	We can now simplify our gradients by reorganizing terms and using $\gamma$s instead of $\delta$s,
	\begin{equation}
	\begin{aligned}
		\nabla_{H} J 
		&= \frac{1}{T}\sum_{i=1}^{T} \sum_{j=1}^{i} \delta^{(1)(i)(j)} \cdot  (h^{(j-1)})^T\\
		&= \frac{1}{T} \sum_{i=1}^{T} \sum_{j=i}^{T} \delta^{(1)(j)(i)} \cdot  (h^{(i-1)})^T\\
		&= \frac{1}{T} \sum_{i=1}^{T} \gamma^{(i)} \cdot  (h^{(i-1)})^T\\
	\end{aligned}
	\end{equation}
	
	\begin{equation}
	\begin{aligned}
		\nabla_{W} J 
		&= \frac{1}{T} \sum_{i=1}^{T} \sum_{j=1}^{i} \delta^{(1)(i)(j)} \cdot  (x^{(j)})^T\\
		&= \frac{1}{T} \sum_{i=1}^{T} \sum_{j=i}^{T} \delta^{(1)(j)(i)} \cdot  (x^{(i)})^T\\
		&= \frac{1}{T} \sum_{i=1}^{T} \gamma^{(i)} \cdot  (x^{(i)})^T\\
	\end{aligned}
	\end{equation}
	
	\begin{equation}
	\begin{aligned}
		\nabla_{b_1} J 
		&= \frac{1}{T} \sum_{i=1}^{T} \sum_{j=1}^{i} \delta^{(1)(i)(j)} \\
		&= \frac{1}{T} \sum_{i=1}^{T} \sum_{j=i}^{T} \delta^{(1)(j)(i)} \\
		&= \frac{1}{T} \sum_{i=1}^{T} \gamma^{(i)} \\
	\end{aligned}
	\end{equation}
	Mnn, putting every thing together,
	\begin{framed}
	\begin{align}
		\delta^{(2)(t)} &= \hat{y}^{(t)} - y^{(t)} \\	
		\delta^{(1)(t)(t)} &= diag[f'(z^{(1)(t)})] \cdot U^T \cdot \delta^{(2)(t)}\\
		\gamma^{(t)} &= 
		\begin{cases}
		\delta^{(1)(t)(t)} &t=T \\
		\delta^{(1)(t)(t)} + diag[f'(z^{(1)(t)})] \cdot H^T \cdot \gamma^{(t+1)} & otherwise
		\end{cases}\\
		\nabla_U J &= \frac{1}{T} \sum_{t=1}^{T}\delta^{(2)(t)} \cdot (h^{
			(t)})^T\\
		\nabla_{c} J &= \frac{1}{T} \sum_{t=1}^{T}\delta^{(2)(t)} \\
		\nabla_H J &= \frac{1}{T} \sum_{t=1}^{T} \gamma^{(t)} \cdot  (h^{(t-1)})^T\\
		\nabla_W J &= \frac{1}{T} \sum_{t=1}^{T} \gamma^{(t)} \cdot  (x^{(t)})^T\\
		\nabla_{b_1} J &= \frac{1}{T} \sum_{t=1}^{T} \gamma^{(t)} \\
	\end{align}
	\end{framed}
\end{document}